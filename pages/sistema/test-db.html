<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Banco de Dados - HubBS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #0A9396;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #005F73;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-item {
            margin: 5px 0;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        .info { color: #0af; }
        .warning { color: #ff0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Banco de Dados HubBS</h1>
        <p>Use esta p√°gina para testar e debugar o banco de dados IndexedDB.</p>
        
        <div>
            <button onclick="testInit()">1. Inicializar Banco</button>
            <button onclick="testCreate()">2. Criar Protocolo Teste</button>
            <button onclick="testList()">3. Listar Protocolos</button>
            <button onclick="testSearch()">4. Buscar Protocolo 000001</button>
            <button onclick="clearLog()">Limpar Log</button>
            <button onclick="clearDatabase()">‚ö†Ô∏è Limpar Banco</button>
        </div>

        <div id="log" class="log">
            <div class="log-item info">üöÄ Pronto para testes...</div>
        </div>
    </div>

    <script src="../js/database.js"></script>
    
    <script>
        let hubDB;
        const logDiv = document.getElementById('log');

        function log(message, type = 'info') {
            const item = document.createElement('div');
            item.className = `log-item ${type}`;
            item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(item);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            logDiv.innerHTML = '<div class="log-item info">üöÄ Log limpo...</div>';
        }

        async function testInit() {
            try {
                log('Iniciando banco de dados...', 'info');
                hubDB = new HubDatabase();
                await hubDB.init();
                log('‚úÖ Banco inicializado com sucesso!', 'success');
            } catch (error) {
                log('‚ùå Erro ao inicializar: ' + error.message, 'error');
            }
        }

        async function testCreate() {
            if (!hubDB) {
                log('‚ö†Ô∏è Execute "1. Inicializar Banco" primeiro', 'warning');
                return;
            }

            try {
                log('Criando protocolo de teste...', 'info');
                
                const relato = {
                    nome: 'Maria Silva',
                    email: 'maria.silva@email.com',
                    telefone: '(13) 98765-4321',
                    cidade: 'Santos',
                    categoria: 'Saneamento',
                    titulo: 'Vazamento de esgoto na Av. Ana Costa',
                    descricao: 'H√° um vazamento de esgoto na Av. Ana Costa, altura do n√∫mero 450, causando mau cheiro e risco √† sa√∫de.',
                    localizacao: 'Av. Ana Costa, 450 - Gonzaga, Santos/SP',
                    prioridade: 'alta',
                    imagens: [],
                    status: 'em_progresso',
                    protocolo: 'HubBS-2025-000001',
                    timestamp: Date.now() - 86400000,
                    data: new Date(Date.now() - 86400000).toISOString(),
                    pontos: 50
                };

                const id = await hubDB.addRelato(relato);
                log('‚úÖ Protocolo criado com ID: ' + id, 'success');
                log('üìã Protocolo: ' + relato.protocolo, 'info');
                
            } catch (error) {
                log('‚ùå Erro ao criar: ' + error.message, 'error');
            }
        }

        async function testList() {
            if (!hubDB) {
                log('‚ö†Ô∏è Execute "1. Inicializar Banco" primeiro', 'warning');
                return;
            }

            try {
                log('Listando todos os protocolos...', 'info');
                const relatos = await hubDB.getRelatos();
                
                log('üìä Total de protocolos: ' + relatos.length, 'success');
                
                if (relatos.length === 0) {
                    log('‚ö†Ô∏è Nenhum protocolo encontrado', 'warning');
                } else {
                    relatos.forEach((r, i) => {
                        log(`${i + 1}. ${r.protocolo || 'SEM PROTOCOLO'} - ${r.titulo} (${r.status})`, 'info');
                    });
                }
            } catch (error) {
                log('‚ùå Erro ao listar: ' + error.message, 'error');
            }
        }

        async function testSearch() {
            if (!hubDB) {
                log('‚ö†Ô∏è Execute "1. Inicializar Banco" primeiro', 'warning');
                return;
            }

            try {
                log('Buscando protocolo HubBS-2025-000001...', 'info');
                const relatos = await hubDB.getRelatos();
                const protocolo = relatos.find(r => r.protocolo === 'HubBS-2025-000001');
                
                if (protocolo) {
                    log('‚úÖ PROTOCOLO ENCONTRADO!', 'success');
                    log('üìÑ T√≠tulo: ' + protocolo.titulo, 'info');
                    log('üìç Cidade: ' + protocolo.cidade, 'info');
                    log('üìä Status: ' + protocolo.status, 'info');
                    log('‚ö° Prioridade: ' + protocolo.prioridade, 'info');
                    log('üéØ Pontos: ' + protocolo.pontos, 'info');
                } else {
                    log('‚ùå PROTOCOLO N√ÉO ENCONTRADO', 'error');
                    log('üí° Execute "2. Criar Protocolo Teste" primeiro', 'warning');
                }
            } catch (error) {
                log('‚ùå Erro na busca: ' + error.message, 'error');
            }
        }

        async function clearDatabase() {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja limpar TODO o banco de dados?')) {
                return;
            }

            try {
                log('Limpando banco de dados...', 'warning');
                
                indexedDB.deleteDatabase('HubDatabase');
                
                log('‚úÖ Banco de dados limpo!', 'success');
                log('üîÑ Recarregue a p√°gina para come√ßar de novo', 'info');
                
                hubDB = null;
            } catch (error) {
                log('‚ùå Erro ao limpar: ' + error.message, 'error');
            }
        }

        // Auto-inicializar
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                testInit();
            }, 500);
        });
    </script>
</body>
</html>
