<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HubBS WhatsApp Bot - Relatos via Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deep-blue': '#005F73',
                        'vibrant-teal': '#0A9396',
                        'ods-green': '#94D2BD',
                        'solar-yellow': '#E9D8A6',
                        'warm-sand': '#FAF3E0',
                        'dark-gray': '#2E2E2E',
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --deep-blue: #005F73;
            --vibrant-teal: #0A9396;
            --ods-green: #94D2BD;
            --solar-yellow: #E9D8A6;
            --warm-orange: #EE9B00;
            --terra-red: #CA6702;
        }

        body {
            min-height: 100vh;
            font-family: 'Inter', -apple-system, sans-serif;
        }

        .whatsapp-container {
            max-width: 480px;
            margin: 2rem auto;
            background: #E5DDD5;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .whatsapp-header {
            background: #075E54;
            color: white;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .chat-area {
            height: 500px;
            overflow-y: auto;
            padding: 1rem;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23E5DDD5" width="100" height="100"/><path d="M0 0 L50 50 L100 0 L100 50 L50 100 L0 50 Z" fill="%23DCE1DE" opacity="0.1"/></svg>');
        }

        .message {
            margin-bottom: 0.75rem;
            display: flex;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 75%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            position: relative;
        }

        .message.bot .message-bubble {
            background: white;
            border-top-left-radius: 0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message.user .message-bubble {
            background: #DCF8C6;
            border-top-right-radius: 0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .message-time {
            font-size: 0.65rem;
            color: #667781;
            margin-top: 0.25rem;
            text-align: right;
        }

        .input-area {
            background: #F0F2F5;
            padding: 0.75rem 1rem;
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .input-field {
            flex: 1;
            background: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 2rem;
            outline: none;
        }

        .send-button {
            background: #075E54;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-button:hover {
            background: #128C7E;
            transform: scale(1.1);
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: white;
            border-radius: 0.5rem;
            max-width: 75px;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #667781;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        .quick-reply {
            display: inline-block;
            background: white;
            border: 1px solid #075E54;
            color: #075E54;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            margin: 0.25rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
        }

        .quick-reply:hover {
            background: #075E54;
            color: white;
        }

        .protocol-card {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 0.5rem;
            text-align: center;
            color: #000;
            font-weight: bold;
        }

        .protocol-number {
            font-size: 1.5rem;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.1em;
            margin: 0.5rem 0;
        }

        .nav-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-white text-dark-gray">
    <!-- Navigation -->
    <nav class="bg-deep-blue text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <a href="../../index.html" class="text-2xl font-bold font-poppins flex items-center gap-2">
                    <img src="../../assets/img/logo.jpeg" alt="HubBS Logo" class="h-12 w-12 object-contain rounded">
                    HubBS
                </a>
                <div class="hidden md:flex items-center gap-6">
                    <a href="../../index.html" class="hover:text-solar-yellow transition">In√≠cio</a>
                    <a href="../sistema/sobre.html" class="hover:text-solar-yellow transition">Sobre</a>
                    <a href="enviar-relato.html" class="hover:text-solar-yellow transition">Enviar Relato</a>
                    <a href="whatsapp-bot.html" class="text-solar-yellow font-bold border-b-2 border-solar-yellow">
                        <i class="fab fa-whatsapp mr-1"></i>WhatsApp Bot
                    </a>
                    <a href="../sistema/dashboard.html" class="hover:text-solar-yellow transition">Dashboard</a>
                    <a href="../sistema/recompensas.html" class="hover:text-solar-yellow transition">Recompensas</a>
                    <a href="../sistema/planos.html" class="hover:text-solar-yellow transition">Planos</a>
                    <a href="../login.html" class="bg-vibrant-teal text-white px-4 py-2 rounded-lg hover:bg-ods-green transition">Login</a>
                </div>
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-white hover:text-solar-yellow focus:outline-none">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="mobile-menu" class="hidden md:hidden pt-4 pb-2">
                <a href="../../index.html" class="block py-2 hover:text-solar-yellow transition">In√≠cio</a>
                <a href="../sistema/sobre.html" class="block py-2 hover:text-solar-yellow transition">Sobre</a>
                <a href="enviar-relato.html" class="block py-2 hover:text-solar-yellow transition">Enviar Relato</a>
                <a href="whatsapp-bot.html" class="block py-2 text-solar-yellow font-bold">
                    <i class="fab fa-whatsapp mr-1"></i>WhatsApp Bot
                </a>
                <a href="../sistema/dashboard.html" class="block py-2 hover:text-solar-yellow transition">Dashboard</a>
                <a href="../sistema/recompensas.html" class="block py-2 hover:text-solar-yellow transition">Recompensas</a>
                <a href="../sistema/planos.html" class="block py-2 hover:text-solar-yellow transition">Planos</a>
                <a href="../login.html" class="block py-2 bg-vibrant-teal px-4 rounded-lg text-center mt-2">Login</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-deep-blue mb-2">
                <i class="fab fa-whatsapp mr-2"></i>HubBS WhatsApp Bot
            </h1>
            <p class="text-dark-gray text-lg">
                Envie relatos conversando com nosso assistente virtual
            </p>
        </div>

        <!-- WhatsApp Simulator -->
        <div class="whatsapp-container">
            <!-- Header -->
            <div class="whatsapp-header">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-2xl">
                    ü§ñ
                </div>
                <div class="flex-1">
                    <h3 class="font-bold">HubBS Assistente</h3>
                    <p class="text-xs opacity-75">online</p>
                </div>
                <button onclick="resetChat()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition">
                    <i class="fas fa-redo"></i>
                </button>
            </div>

            <!-- Chat Area -->
            <div class="chat-area" id="chat-area">
                <!-- Mensagens ser√£o inseridas aqui -->
            </div>

            <!-- Typing Indicator -->
            <div class="message bot">
                <div class="typing-indicator" id="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <button class="text-gray-600 hover:text-gray-800 transition">
                    <i class="fas fa-paperclip text-xl"></i>
                </button>
                <input 
                    type="text" 
                    id="user-input" 
                    class="input-field" 
                    placeholder="Digite uma mensagem..."
                    onkeypress="handleKeyPress(event)"
                >
                <button class="send-button" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- Info Cards -->
        <div class="grid md:grid-cols-3 gap-4 mt-8 max-w-6xl mx-auto">
            <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6 text-center">
                <i class="fas fa-comments text-4xl mb-3" style="color: var(--vibrant-teal);"></i>
                <h3 class="font-bold text-lg mb-2" style="color: var(--deep-blue);">Conversa Natural</h3>
                <p class="text-gray-600 text-sm">Relato via chat como voc√™ conversa no WhatsApp</p>
            </div>
            <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6 text-center">
                <i class="fas fa-robot text-4xl mb-3" style="color: var(--vibrant-teal);"></i>
                <h3 class="font-bold text-lg mb-2" style="color: var(--deep-blue);">IA Integrada</h3>
                <p class="text-gray-600 text-sm">Bot inteligente categoriza automaticamente</p>
            </div>
            <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg p-6 text-center">
                <i class="fas fa-database text-4xl mb-3" style="color: var(--vibrant-teal);"></i>
                <h3 class="font-bold text-lg mb-2" style="color: var(--deep-blue);">Banco Integrado</h3>
                <p class="text-gray-600 text-sm">Relatos salvos automaticamente na plataforma</p>
            </div>
        </div>
    </div>

    <!-- Database Scripts -->
    <script src="../../assets/js/modules/database.js"></script>
    <script src="../../assets/js/modules/api.js"></script>

    <script>
        // Estado da conversa
        let conversationState = {
            step: 'start',
            userData: {
                nome: '',
                telefone: '',
                cidade: '',
                categoria: '',
                ods: '',
                titulo: '',
                descricao: '',
                localizacao: '',
                prioridade: 'media'
            }
        };

        // Mapeamento de categorias
        const categorias = {
            '1': { nome: 'transporte-publico', ods: 'ods-9', label: 'Transporte P√∫blico' },
            '2': { nome: 'infraestrutura-urbana', ods: 'ods-9', label: 'Infraestrutura Urbana' },
            '3': { nome: 'espacos-publicos', ods: 'ods-11', label: 'Espa√ßos P√∫blicos' },
            '4': { nome: 'saneamento-basico', ods: 'ods-11', label: 'Saneamento B√°sico' },
            '5': { nome: 'habitacao', ods: 'ods-11', label: 'Habita√ß√£o' },
            '6': { nome: 'areas-verdes', ods: 'ods-11', label: '√Åreas Verdes' },
            '7': { nome: 'gestao-residuos', ods: 'ods-13', label: 'Gest√£o de Res√≠duos' },
            '8': { nome: 'preservacao-ambiental', ods: 'ods-13', label: 'Preserva√ß√£o Ambiental' }
        };

        const cidades = {
            '1': 'santos',
            '2': 'sao-vicente',
            '3': 'guaruja',
            '4': 'praia-grande',
            '5': 'cubatao',
            '6': 'bertioga',
            '7': 'mongagua',
            '8': 'itanhaem',
            '9': 'peruibe'
        };

        // Inicializar chat
        function initChat() {
            addBotMessage('Ol√°! üëã Bem-vindo ao HubBS Assistente!');
            setTimeout(() => {
                addBotMessage('Sou seu assistente virtual para registrar relatos sobre problemas urbanos na Baixada Santista. üåä');
                setTimeout(() => {
                    addBotMessage('Para come√ßar, por favor me informe seu nome:');
                }, 1500);
            }, 1000);
        }

        // Adicionar mensagem do bot
        function addBotMessage(text, hasQuickReplies = false, quickReplies = []) {
            const chatArea = document.getElementById('chat-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            
            const now = new Date();
            const time = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            let quickReplyHTML = '';
            if (hasQuickReplies && quickReplies.length > 0) {
                quickReplyHTML = '<div class="mt-2">' + 
                    quickReplies.map(reply => `<button class="quick-reply" onclick="selectQuickReply('${reply.value}')">${reply.label}</button>`).join('') +
                    '</div>';
            }
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div>${text}</div>
                    ${quickReplyHTML}
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            chatArea.appendChild(messageDiv);
            scrollToBottom();
        }

        // Adicionar mensagem do usu√°rio
        function addUserMessage(text) {
            const chatArea = document.getElementById('chat-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            
            const now = new Date();
            const time = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    <div>${text}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            chatArea.appendChild(messageDiv);
            scrollToBottom();
        }

        // Mostrar indicador de digita√ß√£o
        function showTyping() {
            document.getElementById('typing-indicator').classList.add('active');
            scrollToBottom();
        }

        // Esconder indicador de digita√ß√£o
        function hideTyping() {
            document.getElementById('typing-indicator').classList.remove('active');
        }

        // Processar mensagem do usu√°rio
        async function processMessage(message) {
            showTyping();
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            hideTyping();

            switch (conversationState.step) {
                case 'start':
                    conversationState.userData.nome = message;
                    conversationState.step = 'telefone';
                    addBotMessage(`Prazer em conhec√™-lo, ${message}! üòä`);
                    setTimeout(() => {
                        addBotMessage('Qual √© o seu telefone/WhatsApp? (com DDD)');
                    }, 1000);
                    break;

                case 'telefone':
                    conversationState.userData.telefone = message;
                    conversationState.step = 'cidade';
                    addBotMessage('Perfeito! üì±');
                    setTimeout(() => {
                        const quickReplies = [
                            { value: '1', label: '1Ô∏è‚É£ Santos' },
                            { value: '2', label: '2Ô∏è‚É£ S. Vicente' },
                            { value: '3', label: '3Ô∏è‚É£ Guaruj√°' },
                            { value: '4', label: '4Ô∏è‚É£ Praia Grande' },
                            { value: '5', label: '5Ô∏è‚É£ Cubat√£o' },
                            { value: '6', label: '6Ô∏è‚É£ Bertioga' },
                            { value: '7', label: '7Ô∏è‚É£ Mongagu√°' },
                            { value: '8', label: '8Ô∏è‚É£ Itanha√©m' },
                            { value: '9', label: '9Ô∏è‚É£ Peru√≠be' }
                        ];
                        addBotMessage('Em qual cidade da Baixada Santista est√° o problema?', true, quickReplies);
                    }, 1000);
                    break;

                case 'cidade':
                    const cidadeKey = message;
                    if (cidades[cidadeKey]) {
                        conversationState.userData.cidade = cidades[cidadeKey];
                        conversationState.step = 'categoria';
                        addBotMessage('‚úÖ Cidade registrada!');
                        setTimeout(() => {
                            const quickReplies = [
                                { value: '1', label: 'üöå Transporte' },
                                { value: '2', label: 'üõ£Ô∏è Infraestrutura' },
                                { value: '3', label: 'üå≥ Espa√ßos P√∫blicos' },
                                { value: '4', label: 'üíß Saneamento' },
                                { value: '5', label: 'üè† Habita√ß√£o' },
                                { value: '6', label: 'üåø √Åreas Verdes' },
                                { value: '7', label: '‚ôªÔ∏è Res√≠duos' },
                                { value: '8', label: 'üå± Meio Ambiente' }
                            ];
                            addBotMessage('Qual categoria melhor descreve o problema?', true, quickReplies);
                        }, 1000);
                    } else {
                        addBotMessage('‚ùå Op√ß√£o inv√°lida. Por favor, clique em uma das op√ß√µes:');
                        setTimeout(() => {
                            const quickReplies = [
                                { value: '1', label: '1Ô∏è‚É£ Santos' },
                                { value: '2', label: '2Ô∏è‚É£ S. Vicente' },
                                { value: '3', label: '3Ô∏è‚É£ Guaruj√°' },
                                { value: '4', label: '4Ô∏è‚É£ Praia Grande' },
                                { value: '5', label: '5Ô∏è‚É£ Cubat√£o' },
                                { value: '6', label: '6Ô∏è‚É£ Bertioga' },
                                { value: '7', label: '7Ô∏è‚É£ Mongagu√°' },
                                { value: '8', label: '8Ô∏è‚É£ Itanha√©m' },
                                { value: '9', label: '9Ô∏è‚É£ Peru√≠be' }
                            ];
                            addBotMessage('Em qual cidade da Baixada Santista est√° o problema?', true, quickReplies);
                        }, 800);
                    }
                    break;

                case 'categoria':
                    const catKey = message;
                    if (categorias[catKey]) {
                        conversationState.userData.categoria = categorias[catKey].nome;
                        conversationState.userData.ods = categorias[catKey].ods;
                        conversationState.step = 'titulo';
                        addBotMessage(`‚úÖ Categoria: ${categorias[catKey].label}`);
                        setTimeout(() => {
                            addBotMessage('Agora, descreva o problema em uma frase curta (t√≠tulo):');
                            addBotMessage('Exemplo: "Buraco na Avenida Central"');
                        }, 1000);
                    } else {
                        addBotMessage('‚ùå Op√ß√£o inv√°lida. Por favor, clique em uma das op√ß√µes:');
                        setTimeout(() => {
                            const quickReplies = [
                                { value: '1', label: 'üöå Transporte' },
                                { value: '2', label: 'üõ£Ô∏è Infraestrutura' },
                                { value: '3', label: 'üå≥ Espa√ßos P√∫blicos' },
                                { value: '4', label: 'üíß Saneamento' },
                                { value: '5', label: 'üè† Habita√ß√£o' },
                                { value: '6', label: 'üåø √Åreas Verdes' },
                                { value: '7', label: '‚ôªÔ∏è Res√≠duos' },
                                { value: '8', label: 'üå± Meio Ambiente' }
                            ];
                            addBotMessage('Qual categoria melhor descreve o problema?', true, quickReplies);
                        }, 800);
                    }
                    break;

                case 'titulo':
                    conversationState.userData.titulo = message;
                    conversationState.step = 'descricao';
                    addBotMessage('‚úÖ T√≠tulo registrado!');
                    setTimeout(() => {
                        addBotMessage('Agora, descreva o problema com mais detalhes:');
                        addBotMessage('(Quando come√ßou? Qual o impacto? Quantas pessoas afeta?)');
                    }, 1000);
                    break;

                case 'descricao':
                    conversationState.userData.descricao = message;
                    conversationState.step = 'localizacao';
                    addBotMessage('‚úÖ Descri√ß√£o registrada!');
                    setTimeout(() => {
                        addBotMessage('Por √∫ltimo, informe o endere√ßo ou localiza√ß√£o exata:');
                        addBotMessage('Exemplo: "Rua XV de Novembro, 123 - Centro"');
                    }, 1000);
                    break;

                case 'localizacao':
                    conversationState.userData.localizacao = message;
                    conversationState.step = 'confirmar';
                    addBotMessage('‚úÖ Localiza√ß√£o registrada!');
                    setTimeout(() => {
                        addBotMessage('Perfeito! Vou resumir seu relato:');
                        setTimeout(() => {
                            const resumo = `
üìã <strong>RESUMO DO RELATO</strong><br><br>
üë§ <strong>Nome:</strong> ${conversationState.userData.nome}<br>
üì± <strong>Telefone:</strong> ${conversationState.userData.telefone}<br>
üìç <strong>Cidade:</strong> ${conversationState.userData.cidade.replace('-', ' ')}<br>
üè∑Ô∏è <strong>Categoria:</strong> ${conversationState.userData.categoria}<br>
üìù <strong>T√≠tulo:</strong> ${conversationState.userData.titulo}<br>
üìÑ <strong>Descri√ß√£o:</strong> ${conversationState.userData.descricao}<br>
üó∫Ô∏è <strong>Localiza√ß√£o:</strong> ${conversationState.userData.localizacao}
                            `;
                            addBotMessage(resumo);
                            setTimeout(() => {
                                const quickReplies = [
                                    { value: 'confirmar', label: '‚úÖ Confirmar e Enviar' },
                                    { value: 'cancelar', label: '‚ùå Cancelar' }
                                ];
                                addBotMessage('Est√° tudo correto?', true, quickReplies);
                            }, 1500);
                        }, 1000);
                    }, 1000);
                    break;

                case 'confirmar':
                    if (message.toLowerCase() === 'confirmar') {
                        await enviarRelato();
                    } else if (message.toLowerCase() === 'cancelar') {
                        addBotMessage('‚ùå Relato cancelado.');
                        setTimeout(() => {
                            addBotMessage('Digite "come√ßar" para iniciar um novo relato.');
                        }, 1000);
                        conversationState.step = 'idle';
                    } else {
                        addBotMessage('‚ùå Op√ß√£o inv√°lida. Por favor, clique em uma das op√ß√µes:');
                        setTimeout(() => {
                            const quickReplies = [
                                { value: 'confirmar', label: '‚úÖ Confirmar e Enviar' },
                                { value: 'cancelar', label: '‚ùå Cancelar' }
                            ];
                            addBotMessage('Est√° tudo correto?', true, quickReplies);
                        }, 800);
                    }
                    break;

                case 'idle':
                    if (message.toLowerCase().includes('come√ßar') || message.toLowerCase().includes('iniciar')) {
                        resetChat();
                    } else {
                        addBotMessage('Digite "come√ßar" para iniciar um novo relato.');
                    }
                    break;
            }
        }

        // Enviar relato para o banco de dados
        async function enviarRelato() {
            showTyping();
            await new Promise(resolve => setTimeout(resolve, 1500));
            hideTyping();

            addBotMessage('üì§ Enviando seu relato...');

            try {
                // Aguardar banco inicializar
                await new Promise(resolve => setTimeout(resolve, 500));

                const relatoData = {
                    nome: conversationState.userData.nome,
                    email: `${conversationState.userData.telefone}@whatsapp.HubBS`,
                    telefone: conversationState.userData.telefone,
                    cidade: conversationState.userData.cidade,
                    categoria: conversationState.userData.categoria,
                    ods: conversationState.userData.ods,
                    titulo: conversationState.userData.titulo,
                    descricao: conversationState.userData.descricao,
                    localizacao: conversationState.userData.localizacao,
                    prioridade: 'media',
                    origem: 'whatsapp',
                    status: 'em_analise'
                };

                const result = await window.hubAPI.enviarRelato(relatoData);

                if (result.success) {
                    setTimeout(() => {
                        addBotMessage('‚úÖ Relato enviado com sucesso!');
                        setTimeout(() => {
                            const protocolHTML = `
                                üéâ <strong>PROTOCOLO GERADO</strong>
                                <div class="protocol-card">
                                    <div>Seu n√∫mero de protocolo:</div>
                                    <div class="protocol-number">${result.protocolo}</div>
                                    <div style="font-size: 0.875rem; margin-top: 0.5rem;">Guarde este n√∫mero para acompanhar seu relato</div>
                                </div>
                            `;
                            addBotMessage(protocolHTML);
                            setTimeout(() => {
                                addBotMessage(`üéÅ Voc√™ ganhou ${result.pontosGanhos || 10} pontos!`);
                                setTimeout(() => {
                                    addBotMessage('Obrigado por contribuir para uma cidade melhor! üåü');
                                    setTimeout(() => {
                                        addBotMessage('Digite "come√ßar" para enviar outro relato.');
                                    }, 1500);
                                }, 1500);
                            }, 1500);
                        }, 1000);
                    }, 500);

                    conversationState.step = 'idle';
                } else {
                    addBotMessage('‚ùå Erro ao enviar relato. Por favor, tente novamente.');
                    conversationState.step = 'idle';
                }
            } catch (error) {
                console.error('Erro:', error);
                addBotMessage('‚ùå Erro ao processar relato. Tente novamente mais tarde.');
                conversationState.step = 'idle';
            }
        }

        // Selecionar resposta r√°pida
        function selectQuickReply(value) {
            const input = document.getElementById('user-input');
            input.value = value;
            sendMessage();
        }

        // Enviar mensagem
        function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();

            if (!message) return;

            addUserMessage(message);
            input.value = '';

            processMessage(message);
        }

        // Handle Enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Scroll to bottom
        function scrollToBottom() {
            const chatArea = document.getElementById('chat-area');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Reset chat
        function resetChat() {
            conversationState = {
                step: 'start',
                userData: {
                    nome: '',
                    telefone: '',
                    cidade: '',
                    categoria: '',
                    ods: '',
                    titulo: '',
                    descricao: '',
                    localizacao: '',
                    prioridade: 'media'
                }
            };

            document.getElementById('chat-area').innerHTML = '';
            initChat();
        }

        // Inicializar ao carregar
        window.addEventListener('load', () => {
            setTimeout(initChat, 500);
        });
    </script>
</body>
</html>

